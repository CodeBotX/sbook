<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>German Greetings Exercise / Bài tập Chào hỏi Tiếng Đức</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            background-color: #f8f9fa;
            padding-top: 20px;
            padding-bottom: 20px;
        }
        .container {
            max-width: 800px;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
            text-align: center;
        }
        .instructions {
            margin-bottom: 25px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 5px;
        }
        .instructions p {
            margin-bottom: 5px;
        }
        .question-item {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
        }
        .question-item .scene-description {
            font-style: italic;
            color: #555;
            margin-bottom: 10px;
        }
        .dialogue p {
            margin-bottom: 8px;
        }
        .dialogue input[type="text"] {
            display: inline-block;
            width: auto;
            min-width: 150px;
            margin: 0 5px;
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #ced4da;
        }
        .feedback-icon {
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }
        .feedback-icon svg {
            width: 20px;
            height: 20px;
        }
        .correct-answer-input {
            border: 2px solid green !important;
            background-color: #e6ffe6;
        }
        .incorrect-answer-input {
            border: 2px solid red !important;
            background-color: #ffe6e6;
        }
        .solution {
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
            border-left: 3px solid #007bff;
        }
        .solution strong {
            color: #0056b3;
        }
        .solution p {
            margin-bottom: 5px;
            font-size: 0.95em;
        }
        .score {
            margin-top: 20px;
            padding: 15px;
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            border-radius: 5px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
        }
        .btn-check-answers {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            font-size: 1.1em;
        }
        .btn-check-answers:hover {
            background-color: #0056b3;
        }
        .scene-header {
            font-size: 1.2em;
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
        }
        .given-dialogue {
            color: #6c757d;
        }

        /* Icon SVGs */
        .icon-correct { fill: green; }
        .icon-incorrect { fill: red; }

    </style>
</head>
<body>
    <div class="container">
        <h1>German Greetings Exercise</h1>
        <h2 class="h5 mb-4">Bài tập Chào hỏi Tiếng Đức</h2>

        <div class="alert alert-info" role="alert">
          <strong>Note:</strong> This exercise is based on an image depicting various social interactions. Each scene below describes a part of that image.
          <br><strong>Lưu ý:</strong> Bài tập này dựa trên một hình ảnh mô tả các tương tác xã hội khác nhau. Mỗi cảnh dưới đây mô tả một phần của hình ảnh đó.
        </div>

        <div class="instructions">
            <p><strong>English:</strong> Fill in the blanks with the appropriate German greetings or farewells based on the context in each scene. Then click "Check Answers" to see your score and the solutions.</p>
            <p><strong>Tiếng Việt:</strong> Điền vào chỗ trống những lời chào hỏi hoặc tạm biệt bằng tiếng Đức phù hợp dựa theo ngữ cảnh trong mỗi cảnh. Sau đó, nhấp vào "Kiểm tra Đáp án" để xem điểm và giải thích chi tiết.</p>
        </div>

        <form id="exerciseForm">
            </form>

        <div class="text-center mt-4">
            <button type="button" class="btn btn-check-answers" onclick="checkAnswers()">Check Answers / Kiểm tra Đáp án</button>
        </div>

        <div id="scoreArea" class="score" style="display: none;"></div>
    </div>

    <svg width="0" height="0" style="display:none;">
      <symbol id="icon-correct" viewBox="0 0 512 512">
        <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/>
      </symbol>
    </svg>

    <svg width="0" height="0" style="display:none;">
      <symbol id="icon-incorrect" viewBox="0 0 512 512">
        <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM175 175c9.4-9.4 24.6-9.4 33.9 0l47 47 47-47c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9l-47 47 47 47c9.4 9.4 9.4 24.6 0 33.9s-24.6 9.4-33.9 0l-47-47-47 47c-9.4 9.4-24.6 9.4-33.9 0s-9.4-24.6 0-33.9l47-47-47-47c-9.4-9.4-9.4-24.6 0-33.9z"/>
      </symbol>
    </svg>


    <script>
        const questionsData = [
            {
                scene: "A", time: "23:00",
                description: "A man (Herr Schneider) and a woman (Frau Moreno) are shaking hands indoors. Frau Moreno is speaking.",
                dialogues: [
                    { type: "given", speaker: "Frau Moreno", line: "Gute Nacht, Frau Moreno." },
                    { type: "input", speaker: "Herr Schneider", inputId: "qA_1", prefix: "", suffix: ", Herr Schneider.", correctAnswers: ["gute nacht"], primaryAnswer: "gute nacht", explanation: "'Gute Nacht' (Good night) is used when leaving late in the evening (23:00 / 11 PM) or going to bed.", vietnameseFull: '"Gute Nacht, Herr Schneider." (Chúc ngủ ngon, ông Schneider.)' }
                ]
            },
            {
                scene: "B", time: "09:30",
                description: "Two young women, Rasha and Natalja, are greeting each other outdoors, possibly at school or university. Natalja is waving.",
                dialogues: [
                    { type: "input", speaker: "Natalja", inputId: "qB_1", prefix: "", suffix: ", Rasha!", correctAnswers: ["guten morgen", "hallo"], primaryAnswer: "guten morgen", explanation: "'Guten Morgen' (Good morning) is used until noon (09:30 / 9:30 AM). 'Hallo' (Hello) is a general greeting.", vietnameseFull: '"Guten Morgen, Rasha!" (Chào buổi sáng, Rasha!)' },
                    { type: "input", speaker: "Rasha", inputId: "qB_2", prefix: "", suffix: ", Natalja!", correctAnswers: ["guten morgen", "hallo"], primaryAnswer: "guten morgen", explanation: "'Guten Morgen' (Good morning) is appropriate here. 'Hallo' (Hello) is also acceptable.", vietnameseFull: '"Guten Morgen, Natalja!" (Chào buổi sáng, Natalja!)' }
                ]
            },
            {
                scene: "C", time: "20:00",
                description: "A father (Papa) is at the side of a bunk bed where two children (Kinder) are.",
                dialogues: [
                    { type: "input", speaker: "Papa", inputId: "qC_1", prefix: "", suffix: ", Kinder.", correctAnswers: ["gute nacht"], primaryAnswer: "gute nacht", explanation: "'Gute Nacht' (Good night) is said to children at bedtime (20:00 / 8 PM).", vietnameseFull: '"Gute Nacht, Kinder." (Chúc các con ngủ ngon.)' },
                    { type: "input", speaker: "Kinder", inputId: "qC_2", prefix: "", suffix: ", Papa.", correctAnswers: ["gute nacht"], primaryAnswer: "gute nacht", explanation: "Children would reply 'Gute Nacht' to their father.", vietnameseFull: '"Gute Nacht, Papa." (Chúc bố ngủ ngon.)' }
                ]
            },
            {
                scene: "D", time: "16:00",
                description: "Two men (Herr Celik and Herr Johnson) are shaking hands, seemingly parting ways. Herr Celik is speaking.",
                dialogues: [
                    { type: "given", speaker: "Herr Celik", line: "Auf Wiedersehen, Herr Johnson." },
                    { type: "input", speaker: "Herr Johnson", inputId: "qD_1", prefix: "", suffix: ", Herr Celik.", correctAnswers: ["auf wiedersehen", "tschüss"], primaryAnswer: "auf wiedersehen", explanation: "'Auf Wiedersehen' (Goodbye - formal) is appropriate in a formal context (indicated by 'Herr') at 16:00 / 4 PM. 'Tschüss' (Bye - informal) might be used if they know each other well, but 'Auf Wiedersehen' matches the given dialogue.", vietnameseFull: '"Auf Wiedersehen, Herr Celik." (Tạm biệt, ông Celik.)' }
                ]
            },
            {
                scene: "E", time: "14:30",
                description: "Two young girls, Klara and Ana, are waving at each other outdoors, possibly after playing.",
                dialogues: [
                    { type: "input", speaker: "Ana", inputId: "qE_1", prefix: "", suffix: ", Klara!", correctAnswers: ["tschüss", "hallo"], primaryAnswer: "tschüss", explanation: "'Tschüss' (Bye) is a common informal farewell, suitable for children (14:30 / 2:30 PM). Waving often indicates a farewell. If they were meeting, 'Hallo' or 'Guten Tag' could be used.", vietnameseFull: '"Tschüss, Klara!" (Tạm biệt, Klara!)' },
                    { type: "input", speaker: "Klara", inputId: "qE_2", prefix: "", suffix: ", Ana!", correctAnswers: ["tschüss", "hallo"], primaryAnswer: "tschüss", explanation: "'Tschüss' (Bye) is the reciprocal informal farewell.", vietnameseFull: '"Tschüss, Ana!" (Tạm biệt, Ana!)' }
                ]
            }
        ];

        let totalInputs = 0;

        function buildExercise() {
            const form = document.getElementById('exerciseForm');
            questionsData.forEach(item => {
                const questionItemDiv = document.createElement('div');
                questionItemDiv.className = 'question-item';
                
                const header = document.createElement('div');
                header.className = 'scene-header';
                header.innerHTML = `Scene ${item.scene} (${item.time})`;
                questionItemDiv.appendChild(header);

                const descriptionP = document.createElement('p');
                descriptionP.className = 'scene-description';
                descriptionP.textContent = item.description;
                questionItemDiv.appendChild(descriptionP);

                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'dialogue';

                item.dialogues.forEach(dialogue => {
                    const p = document.createElement('p');
                    if (dialogue.type === 'given') {
                        p.className = 'given-dialogue';
                        p.innerHTML = `<strong>${dialogue.speaker}:</strong> "${dialogue.line}"`;
                    } else if (dialogue.type === 'input') {
                        totalInputs++;
                        p.innerHTML = `<strong>${dialogue.speaker}:</strong> ${dialogue.prefix} <input type="text" id="${dialogue.inputId}" data-primary-answer="${dialogue.primaryAnswer}" data-all-answers='${JSON.stringify(dialogue.correctAnswers)}' data-explanation="${dialogue.explanation}" data-vietnamese="${dialogue.vietnameseFull}"> ${dialogue.suffix} <span id="feedback_${dialogue.inputId}" class="feedback-icon"></span>`;
                        const solutionDiv = document.createElement('div');
                        solutionDiv.id = `solution_${dialogue.inputId}`;
                        solutionDiv.className = 'solution';
                        solutionDiv.style.display = 'none';
                        dialogueDiv.appendChild(p); // Append p before solutionDiv related to it
                        dialogueDiv.appendChild(solutionDiv); // Append solutionDiv after the p
                    }
                });
                questionItemDiv.appendChild(dialogueDiv);
                form.appendChild(questionItemDiv);
            });
        }

        function checkAnswers() {
            let score = 0;
            let isFirstCheck = document.getElementById('scoreArea').style.display === 'none';

            questionsData.forEach(item => {
                item.dialogues.forEach(dialogue => {
                    if (dialogue.type === 'input') {
                        const inputField = document.getElementById(dialogue.inputId);
                        const feedbackIconContainer = document.getElementById(`feedback_${dialogue.inputId}`);
                        const solutionContainer = document.getElementById(`solution_${dialogue.inputId}`);
                        
                        // Clear previous feedback
                        inputField.classList.remove('correct-answer-input', 'incorrect-answer-input');
                        feedbackIconContainer.innerHTML = '';
                        solutionContainer.innerHTML = '';
                        solutionContainer.style.display = 'none';

                        const userAnswer = inputField.value.trim().toLowerCase().replace(/[.!,]$/, '');
                        const correctAnswers = JSON.parse(inputField.dataset.allAnswers);
                        const primaryAnswer = inputField.dataset.primaryAnswer;
                        
                        let isCorrect = false;
                        if (correctAnswers.includes(userAnswer)) {
                            isCorrect = true;
                            if (isFirstCheck || !inputField.dataset.answeredCorrectlyOnce) {
                                score++;
                                inputField.dataset.answeredCorrectlyOnce = true; // Mark as correctly answered once
                            }
                        } else {
                           inputField.dataset.answeredCorrectlyOnce = false; // Reset if now incorrect
                        }


                        if (isCorrect) {
                            inputField.classList.add('correct-answer-input');
                            feedbackIconContainer.innerHTML = '<svg class="icon-correct"><use xlink:href="#icon-correct"></use></svg>';
                        } else {
                            inputField.classList.add('incorrect-answer-input');
                            feedbackIconContainer.innerHTML = '<svg class="icon-incorrect"><use xlink:href="#icon-incorrect"></use></svg>';
                        }

                        // Solution display
                        let solutionHTML = `<p><strong>Correct Answer(s):</strong> ${correctAnswers.map(ans => `"${ans.charAt(0).toUpperCase() + ans.slice(1)}"`).join(' or ')}. (Primary: "${primaryAnswer.charAt(0).toUpperCase() + primaryAnswer.slice(1)}")</p>`;
                        solutionHTML += `<p><strong>Explanation:</strong> ${inputField.dataset.explanation}</p>`;
                        solutionHTML += `<p><strong>Full Sentence (Vietnamese):</strong> ${inputField.dataset.vietnamese}</p>`;
                        solutionContainer.innerHTML = solutionHTML;
                        solutionContainer.style.display = 'block';
                    }
                });
            });
            
            // Update score display
            const scoreArea = document.getElementById('scoreArea');
            scoreArea.textContent = `You scored ${score} / ${totalInputs} points. (Điểm của bạn: ${score} / ${totalInputs}) (Note: Points are awarded for the first correct attempt per field if you re-check.)`;
            scoreArea.style.display = 'block';
            
            // Prevent re-scoring unless behavior is desired (current setup allows rescoring from 0 if not careful)
            // To prevent re-scoring and lock score after first check, we would need a flag.
            // The current logic re-evaluates score. Let's refine to score based on current state.
            // The `inputField.dataset.answeredCorrectlyOnce` is designed to only add to score once for each field if they get it right,
            // but the overall score is recalculated. This is tricky. A simple always recalculate score is easier:
            
            // Simpler score recalculation for this version:
            let currentCorrectCount = 0;
            document.querySelectorAll('input[type="text"]').forEach(inputField => {
                 const userAnswer = inputField.value.trim().toLowerCase().replace(/[.!,]$/, '');
                 const correctAnswers = JSON.parse(inputField.dataset.allAnswers);
                 if (correctAnswers.includes(userAnswer)) {
                    currentCorrectCount++;
                 }
            });
            scoreArea.textContent = `You scored ${currentCorrectCount} / ${totalInputs} points. (Điểm của bạn: ${currentCorrectCount} / ${totalInputs})`;


        }

        // Build the exercise on page load
        document.addEventListener('DOMContentLoaded', buildExercise);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>