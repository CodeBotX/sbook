<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài Tập Ngữ Pháp: Passive Voice - Phần A</title>
    <!-- Bootstrap CSS for styling and responsiveness -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Google Fonts for "Open Sans" -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for feedback icons (check/cross) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Custom stylesheet for additional styling -->
    <link rel="stylesheet" href="../../assets/style.css">
    <style>
        /* Custom styling for the image in Exercise A */
        .exercise-image {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        /* Styling for the matching sections */
        .matching-section {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .matching-column {
            flex: 1;
            min-width: 280px; /* Ensure columns don't get too narrow */
            padding: 0 15px;
        }
        .matching-item {
            margin-bottom: 15px;
            display: flex;
            align-items: baseline;
        }
        .matching-item .letter {
            font-weight: bold;
            margin-right: 10px;
            color: #007bff;
            flex-shrink: 0;
        }
        .matching-item .text {
            flex-grow: 1;
        }
        .exercise-item.matching {
            display: flex;
            align-items: baseline;
            margin-bottom: 15px;
        }
        .exercise-item.matching .question-number {
            margin-right: 10px;
        }
        .exercise-item.matching .text-segment {
            flex-grow: 1;
            margin-right: 10px;
        }
        .exercise-item.matching .answer-input {
            width: 50px; /* Small input for letter A-F */
            text-align: center;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .matching-column {
                flex-basis: 100%; /* Stack columns on small screens */
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container container-main">
        <!-- Main heading of the exercise -->
        <div class="d-flex align-items-center justify-content-center mb-4">
            <h1>Bài Tập Ngữ Pháp</h1>
        </div>
        <!-- Sub-heading for this specific exercise part -->
        <h2>A. Look at the picture and match to make sentences.</h2>
        <!-- Instructions for the user -->
        <p class="instruction">
            <strong>Hướng dẫn:</strong> Nhìn vào bức tranh và nối để tạo thành câu.
            <br>
            <span class="text-muted">(Lưu ý: Đáp án và lời giải chi tiết sẽ hiển thị sau khi bạn nhấn "Kiểm tra".)</span>
        </p>

        <!-- Image for the exercise -->
        <img src="image_A.png" alt="Hình ảnh xe tải diễu hành lễ hội" class="exercise-image">

        <!-- Matching options section -->
        <div class="matching-section">
            <div class="matching-column">
                <div class="matching-item">
                    <span class="letter">A</span>
                    <span class="text">been given a banana by the pirate.</span>
                </div>
                <div class="matching-item">
                    <span class="letter">B</span>
                    <span class="text">going to be given a balloon by the astronaut.</span>
                </div>
                <div class="matching-item">
                    <span class="letter">C</span>
                    <span class="text">be sung by the cowboy.</span>
                </div>
            </div>
            <div class="matching-column">
                <div class="matching-item">
                    <span class="letter">D</span>
                    <span class="text">being driven by a clown.</span>
                </div>
                <div class="matching-item">
                    <span class="letter">E</span>
                    <span class="text">been bought from a fancy-dress shop?</span>
                </div>
                <div class="matching-item">
                    <span class="letter">F</span>
                    <span class="text">been decorated with lots of flowers.</span>
                </div>
            </div>
        </div>

        <!-- Form containing all the exercise questions -->
        <form id="grammarForm">
            <!-- Question 1 -->
            <div class="exercise-item matching">
                <span class="question-number">1.</span>
                <span class="text-segment">The carnival lorry is </span>
                <input type="text" class="form-control answer-input" id="q1" name="q1" maxlength="1">
                <i class="feedback-icon fa-solid" id="icon1"></i>
            </div>

            <!-- Question 2 -->
            <div class="exercise-item matching">
                <span class="question-number">2.</span>
                <span class="text-segment">The lorry has </span>
                <input type="text" class="form-control answer-input" id="q2" name="q2" maxlength="1">
                <i class="feedback-icon fa-solid" id="icon2"></i>
            </div>

            <!-- Question 3 -->
            <div class="exercise-item matching">
                <span class="question-number">3.</span>
                <span class="text-segment">The gorilla has </span>
                <input type="text" class="form-control answer-input" id="q3" name="q3" maxlength="1">
                <i class="feedback-icon fa-solid" id="icon3"></i>
            </div>

            <!-- Question 4 -->
            <div class="exercise-item matching">
                <span class="question-number">4.</span>
                <span class="text-segment">Everyone watching is </span>
                <input type="text" class="form-control answer-input" id="q4" name="q4" maxlength="1">
                <i class="feedback-icon fa-solid" id="icon4"></i>
            </div>

            <!-- Question 5 -->
            <div class="exercise-item matching">
                <span class="question-number">5.</span>
                <span class="text-segment">The best song might </span>
                <input type="text" class="form-control answer-input" id="q5" name="q5" maxlength="1">
                <i class="feedback-icon fa-solid" id="icon5"></i>
            </div>

            <!-- Question 6 -->
            <div class="exercise-item matching">
                <span class="question-number">6.</span>
                <span class="text-segment">Have the costumes </span>
                <input type="text" class="form-control answer-input" id="q6" name="q6" maxlength="1">
                <i class="feedback-icon fa-solid" id="icon6"></i>
            </div>

            <!-- Action buttons -->
            <div class="buttons text-center mt-5">
                <button type="button" class="btn btn-primary me-3" onclick="submitAnswers()">Kiểm tra</button>
                <button type="button" class="btn btn-secondary" onclick="resetExercise()">Làm lại</button>
            </div>
        </form>

        <!-- Score display area -->
        <div id="scoreDisplay" class="score-display mt-4"></div>

        <!-- Detailed solution section, hidden by default -->
        <div class="solution-section" id="detailedSolution">
            <h2>Lời giải chi tiết và Giải thích</h2>
            <div class="solution-list">
                <!-- Solutions will be dynamically added here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Bootstrap JavaScript bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- Link to common JavaScript functions -->
    <script src="../../assets/common.js"></script>

    <script>
        // Data containing correct answers, original text, fixed text templates, explanations, and grammar notes for each question.
        const questionsData = {
            'q1': {
                correctAnswers: ['D'],
                originalText: 'The carnival lorry is',
                matchingOption: 'being driven by a clown.',
                fixedTextTemplate: 'The carnival lorry is <span class="correct-answer-text">being driven by a clown.</span>',
                explanation: 'Xe tải diễu hành đang được một chú hề lái. Sử dụng thì hiện tại tiếp diễn bị động (is being driven) để diễn tả hành động đang xảy ra.',
                grammarNote: 'Cấu trúc: S + am/is/are + being + P.P.'
            },
            'q2': {
                correctAnswers: ['F'],
                originalText: 'The lorry has',
                matchingOption: 'been decorated with lots of flowers.',
                fixedTextTemplate: 'The lorry has <span class="correct-answer-text">been decorated with lots of flowers.</span>',
                explanation: 'Xe tải đã được trang trí bằng rất nhiều hoa. Sử dụng thì hiện tại hoàn thành bị động (has been decorated) để diễn tả hành động đã hoàn thành và có kết quả ở hiện tại.',
                grammarNote: 'Cấu trúc: S + has/have + been + P.P.'
            },
            'q3': {
                correctAnswers: ['A'],
                originalText: 'The gorilla has',
                matchingOption: 'been given a banana by the pirate.',
                fixedTextTemplate: 'The gorilla has <span class="correct-answer-text">been given a banana by the pirate.</span>',
                explanation: 'Con gorilla đã được tên cướp biển cho một quả chuối. Sử dụng thì hiện tại hoàn thành bị động (has been given) để diễn tả hành động đã hoàn thành và có kết quả ở hiện tại.',
                grammarNote: 'Cấu trúc: S + has/have + been + P.P.'
            },
            'q4': {
                correctAnswers: ['B'],
                originalText: 'Everyone watching is',
                matchingOption: 'going to be given a balloon by the astronaut.',
                fixedTextTemplate: 'Everyone watching is <span class="correct-answer-text">going to be given a balloon by the astronaut.</span>',
                explanation: 'Mọi người đang xem sẽ được phi hành gia tặng một quả bóng bay. Sử dụng cấu trúc "be going to" bị động (is going to be given) để diễn tả một kế hoạch hoặc dự định trong tương lai.',
                grammarNote: 'Cấu trúc: S + am/is/are + going to + be + P.P.'
            },
            'q5': {
                correctAnswers: ['C'],
                originalText: 'The best song might',
                matchingOption: 'be sung by the cowboy.',
                fixedTextTemplate: 'The best song might <span class="correct-answer-text">be sung by the cowboy.</span>',
                explanation: 'Bài hát hay nhất có thể được chàng cao bồi hát. Sử dụng động từ khuyết thiếu bị động (might be sung) để diễn tả khả năng.',
                grammarNote: 'Cấu trúc: S + modal verb + be + P.P.'
            },
            'q6': {
                correctAnswers: ['E'],
                originalText: 'Have the costumes',
                matchingOption: 'been bought from a fancy-dress shop?',
                fixedTextTemplate: 'Have the costumes <span class="correct-answer-text">been bought from a fancy-dress shop?</span>',
                explanation: 'Những bộ trang phục đã được mua từ một cửa hàng đồ hóa trang phải không? Sử dụng thì hiện tại hoàn thành bị động dạng câu hỏi (Have been bought) để hỏi về một hành động đã hoàn thành.',
                grammarNote: 'Cấu trúc câu hỏi: Has/Have + S + been + P.P.?'
            }
        };

        /**
         * Submits the user's answers for the Passive Voice exercise,
         * calculates the score, provides feedback, and displays detailed solutions.
         * This function uses generic helpers from common.js.
         */
        function submitAnswers() {
            let score = 0;
            const totalQuestions = Object.keys(questionsData).length;

            // Clear previous solutions and show solution section
            const solutionListDiv = document.querySelector('#detailedSolution .solution-list');
            solutionListDiv.innerHTML = '';
            document.getElementById('detailedSolution').style.display = 'block';

            // Loop through all questions
            for (let i = 1; i <= totalQuestions; i++) {
                const qId = `q${i}`;
                const inputElement = document.getElementById(qId);
                const feedbackIcon = document.getElementById(`icon${i}`);
                const questionData = questionsData[qId];

                if (!inputElement || !questionData) {
                    console.warn(`Missing element or data for ${qId}`);
                    continue;
                }

                const userAnswer = normalizeAnswer(inputElement.value); // Use normalizeAnswer from common.js
                let isCorrect = false;

                // Check if the user's answer matches the correct letter (A, B, C, etc.)
                isCorrect = questionData.correctAnswers.some(correctAns => normalizeAnswer(correctAns) === userAnswer);

                // Display feedback on the input field
                inputElement.classList.remove('is-valid', 'is-invalid');
                if (isCorrect) {
                    inputElement.classList.add('is-valid');
                } else {
                    inputElement.classList.add('is-invalid');
                }

                // Display feedback icon
                if (feedbackIcon) {
                    feedbackIcon.classList.remove('fa-check-circle', 'fa-times-circle', 'text-success', 'text-danger');
                    if (isCorrect) {
                        feedbackIcon.classList.add('fa-check-circle', 'text-success');
                    } else {
                        feedbackIcon.classList.add('fa-times-circle', 'text-danger');
                    }
                    feedbackIcon.style.display = 'inline-block';
                }

                if (isCorrect) {
                    score++;
                }

                // Add detailed solution using a custom function for matching exercises
                addMatchingSolutionItem(i, questionData, userAnswer);
            }

            // Display the final score using the common function
            displayScore(score, totalQuestions); // Use displayScore from common.js
        }

        /**
         * Custom function to add a detailed solution item for matching exercises.
         * @param {number} questionNumber - The sequential number of the question.
         * @param {object} questionData - The data object for the specific question.
         * @param {string} userAnswer - The user's submitted answer (letter).
         */
        function addMatchingSolutionItem(questionNumber, questionData, userAnswer) {
            const solutionListDiv = document.querySelector('#detailedSolution .solution-list');
            if (!solutionListDiv) {
                console.error("Solution list div not found.");
                return;
            }

            const solutionItem = document.createElement('div');
            solutionItem.classList.add('solution-item');

            // Original question text
            const originalQuestionDiv = document.createElement('div');
            originalQuestionDiv.classList.add('original-question');
            originalQuestionDiv.innerHTML = `<strong>${questionNumber}. Câu gốc:</strong> ${questionData.originalText} <span class="text-muted">(Đáp án của bạn: ${userAnswer.toUpperCase()})</span>`;
            solutionItem.appendChild(originalQuestionDiv);

            // Correct sentence with highlighted answer
            const correctSentenceDiv = document.createElement('div');
            correctSentenceDiv.classList.add('correct-sentence');
            correctSentenceDiv.innerHTML = `<strong>Câu đúng:</strong> ${questionData.fixedTextTemplate}`;
            solutionItem.appendChild(correctSentenceDiv);

            // Explanation and grammar note
            const explanationDiv = document.createElement('div');
            explanationDiv.classList.add('explanation');
            explanationDiv.innerHTML = `<strong>Giải thích:</strong> ${questionData.explanation}<br><em>${questionData.grammarNote}</em>`;
            solutionItem.appendChild(explanationDiv);

            solutionListDiv.appendChild(solutionItem);
        }

        // The resetExercise function is imported from common.js and works universally
    </script>
</body>
</html>
