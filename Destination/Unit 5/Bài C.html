<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài Tập Viết Câu - Quá Khứ Hoàn Thành Đơn</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* General body styling */
        body {
            font-family: 'Open Sans', sans-serif;
            background-color: #f0f2f5;
            line-height: 1.6;
            color: #333;
            padding-top: 40px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        /* Main container for the exercise */
        .container-main {
            max-width: 900px;
            margin-top: 40px;
            margin-bottom: 40px;
            background-color: #ffffff;
            padding: 35px 45px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        /* Headings */
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
            font-weight: 700;
        }
        h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
            font-weight: 600;
        }

        /* Instruction section styling */
        .instruction {
            font-size: 1.1em;
            margin-bottom: 30px;
            color: #555;
            text-align: center;
            line-height: 1.5;
            background-color: #e8f5e9;
            border-left: 6px solid #4CAF50;
            padding: 20px 25px;
            border-radius: 10px;
            color: #388e3c;
        }

        /* Styling for each exercise item (question line) */
        .exercise-item {
            margin-bottom: 25px; /* Increased margin for better separation */
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            background-color: #fdfdfd;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        .exercise-item .question-number {
            font-weight: 600;
            color: #2c3e50;
            margin-right: 15px;
            margin-bottom: 10px; /* Space below number */
            display: block; /* Ensure number is on its own line */
        }
        .exercise-item .prompt-text {
            font-style: italic;
            color: #777;
            margin-bottom: 15px;
        }
        .exercise-item .answer-group {
            display: flex;
            align-items: baseline;
            flex-wrap: wrap;
            width: 100%;
        }
        .exercise-item .answer-input {
            flex-grow: 1; /* Allow input to grow and fill space */
            min-width: 250px; /* Minimum width for input */
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ced4da;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            font-size: 1em; /* Ensure font size is readable */
        }
        .exercise-item .answer-input:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        /* Feedback borders for inputs */
        .exercise-item .answer-input.is-valid {
            border-color: #198754 !important;
            box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25) !important;
            background-color: #d1e7dd;
            color: #0f5132;
        }
        .exercise-item .answer-input.is-invalid {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25) !important;
            background-color: #f8d7da;
            color: #842029;
        }

        /* Feedback icons (check/cross) */
        .feedback-icon {
            margin-left: 10px;
            font-size: 1.2em;
            display: none; /* Hidden by default, shown by JS */
            flex-shrink: 0;
        }
        .feedback-icon.text-success { color: #198754; }
        .feedback-icon.text-danger { color: #dc3545; }

        /* Buttons styling */
        .buttons .btn {
            padding: 12px 30px;
            font-size: 1.1em;
            margin: 0 15px;
            border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .buttons .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        /* Score display styling */
        .score-display {
            font-size: 1.3em;
            font-weight: 700;
            color: #007bff;
            margin-top: 30px;
            margin-bottom: 25px;
            text-align: center;
            padding: 10px 20px;
            border-radius: 8px;
            background-color: #e6f7ff;
            border: 1px solid #b3e0ff;
            display: none;
        }
        .score-display.text-success { background-color: #d1e7dd; border-color: #a3cfb4; color: #198754; }
        .score-display.text-warning { background-color: #fff3cd; border-color: #ffeeba; color: #ffc107; }
        .score-display.text-danger { background-color: #f8d7da; border-color: #f5c2c7; color: #dc3545; }

        /* Detailed solution section styling */
        .solution-section {
            margin-top: 40px;
            padding-top: 25px;
            border-top: 1px dashed #ced4da;
            display: none;
        }
        .solution-section h2 {
            color: #007bff;
            font-weight: 700;
            margin-bottom: 25px;
            text-align: center;
        }
        .solution-list .solution-item {
            margin-bottom: 20px;
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-left: 5px solid #007bff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .solution-list .solution-item .question-text-solution {
            font-weight: 600;
            color: #34495e;
            margin-bottom: 8px;
        }
        .solution-list .solution-item .correct-answer-text {
            font-weight: 700;
            color: #198754;
            text-decoration: underline;
            margin-right: 5px;
        }
        .solution-list .solution-item .grammar-explanation {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
            background-color: #e9ecef;
            padding: 8px 12px;
            border-radius: 5px;
            border-left: 3px solid #6c757d;
        }
        .solution-list .solution-item .translation {
            font-style: italic;
            color: #6c757d;
            font-size: 0.95em;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #e0e0e0;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container-main {
                padding: 25px;
                margin: 20px auto;
            }
            h1 {
                font-size: 1.8em;
            }
            h2 {
                font-size: 1.5em;
            }
            .instruction {
                font-size: 0.95em;
                padding: 15px;
            }
            .exercise-item {
                padding: 15px;
                margin-bottom: 20px;
            }
            .exercise-item .answer-input {
                width: 100%;
                max-width: 100%;
                margin-bottom: 10px;
            }
            .buttons .btn {
                font-size: 1.1em;
                padding: 10px 25px;
                margin: 0 8px;
            }
            .score-display {
                font-size: 1.3em;
                padding: 12px;
            }
            .solution-list .solution-item {
                padding: 10px 15px;
            }
            .solution-list .solution-item .grammar-explanation,
            .solution-list .solution-item .translation {
                font-size: 0.85em;
            }
        }
    </style>
</head>
<body>
    <div class="container container-main">
        <div class="d-flex align-items-center justify-content-center mb-4">
            <h1>Bài Tập Ngữ Pháp</h1>
        </div>
        <h2>Viết câu sử dụng thì Quá khứ Hoàn thành Đơn</h2>
        <p class="instruction">
            <strong>Instructions:</strong> Write sentences using the prompts. One of the verbs must be in the past perfect simple.
            <br>
            <strong>Hướng dẫn:</strong> Viết câu sử dụng các gợi ý. Một trong các động từ phải ở thì Quá khứ Hoàn thành Đơn.
            <br>
            <span class="text-muted">(Lưu ý: Đáp án và lời giải chi tiết sẽ hiển thị sau khi bạn nhấn "Kiểm tra".)</span>
        </p>

        <form id="grammarForm">
            <div class="exercise-item">
                <span class="question-number">1.</span>
                <p class="prompt-text">we / just / hear / the news / when / you / ring</p>
                <div class="answer-group">
                    <input type="text" class="form-control answer-input" id="q1" name="q1" placeholder="Your answer">
                    <i class="feedback-icon fa-solid" id="icon1"></i>
                </div>
            </div>

            <div class="exercise-item">
                <span class="question-number">2.</span>
                <p class="prompt-text">I / already / think of / that / before / you / suggest / it</p>
                <div class="answer-group">
                    <input type="text" class="form-control answer-input" id="q2" name="q2" placeholder="Your answer">
                    <i class="feedback-icon fa-solid" id="icon2"></i>
                </div>
            </div>

            <div class="exercise-item">
                <span class="question-number">3.</span>
                <p class="prompt-text">when / I / turn on / the TV / the programme / already / start</p>
                <div class="answer-group">
                    <input type="text" class="form-control answer-input" id="q3" name="q3" placeholder="Your answer">
                    <i class="feedback-icon fa-solid" id="icon3"></i>
                </div>
            </div>

            <div class="exercise-item">
                <span class="question-number">4.</span>
                <p class="prompt-text">she / be / hungry / because / she / not / eat / anything / all day</p>
                <div class="answer-group">
                    <input type="text" class="form-control answer-input" id="q4" name="q4" placeholder="Your answer">
                    <i class="feedback-icon fa-solid" id="icon4"></i>
                </div>
            </div>

            <div class="exercise-item">
                <span class="question-number">5.</span>
                <p class="prompt-text">by the time / I leave / school / I / decide / to become / a musician</p>
                <div class="answer-group">
                    <input type="text" class="form-control answer-input" id="q5" name="q5" placeholder="Your answer">
                    <i class="feedback-icon fa-solid" id="icon5"></i>
                </div>
            </div>

            <div class="buttons text-center mt-5">
                <button type="button" class="btn btn-primary me-3" onclick="submitAnswers()">Kiểm tra</button>
                <button type="button" class="btn btn-secondary" onclick="resetExercise()">Làm lại</button>
            </div>
        </form>

        <div id="scoreDisplay" class="score-display mt-4"></div>

        <div class="solution-section" id="detailedSolution">
            <h2>Lời giải chi tiết và Giải thích</h2>
            <div class="solution-list">
                </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // Define correct answers, full sentences, translations, and explanations for each question
        const questionsData = {
            'q1': {
                answers: [
                    'We had just heard the news when you rang.',
                    'We\'d just heard the news when you rang.'
                ],
                prompt: 'we / just / hear / the news / when / you / ring',
                fullSentence: 'We had just heard the news when you rang.',
                translation: 'Chúng tôi vừa mới nghe tin tức khi bạn gọi điện.',
                explanation: 'Hành động "nghe tin tức" đã xảy ra và hoàn thành ngay trước hành động "bạn gọi điện" trong quá khứ. "Just" nhấn mạnh tính tức thời của hành động.',
                grammar_note: 'Sử dụng Quá khứ Hoàn thành (had + P.P.) cho hành động xảy ra trước và Quá khứ Đơn (V2/ed) cho hành động xảy ra sau. "Just" thường đứng giữa "had" và P.P.'
            },
            'q2': {
                answers: [
                    'I had already thought of that before you suggested it.',
                    'I\'d already thought of that before you suggested it.'
                ],
                prompt: 'I / already / think of / that / before / you / suggest / it',
                fullSentence: 'I had already thought of that before you suggested it.',
                translation: 'Tôi đã nghĩ đến điều đó rồi trước khi bạn gợi ý.',
                explanation: 'Hành động "tôi đã nghĩ" xảy ra và hoàn thành trước hành động "bạn gợi ý" trong quá khứ. "Already" nhấn mạnh việc hoàn thành trước đó.',
                grammar_note: 'Sử dụng Quá khứ Hoàn thành (had + P.P.) cho hành động xảy ra trước và Quá khứ Đơn (V2/ed) cho hành động xảy ra sau. "Already" thường đứng giữa "had" và P.P.'
            },
            'q3': {
                answers: [
                    'When I turned on the TV, the programme had already started.',
                    'When I turned on the TV, the programme\'d already started.'
                ],
                prompt: 'when / I / turn on / the TV / the programme / already / start',
                fullSentence: 'When I turned on the TV, the programme had already started.',
                translation: 'Khi tôi bật TV, chương trình đã bắt đầu rồi.',
                explanation: 'Hành động "chương trình bắt đầu" xảy ra và hoàn thành trước hành động "tôi bật TV" trong quá khứ. "Already" nhấn mạnh việc hoàn thành trước đó.',
                grammar_note: 'Sử dụng Quá khứ Hoàn thành (had + P.P.) cho hành động xảy ra trước và Quá khứ Đơn (V2/ed) cho hành động xảy ra sau. "Already" thường đứng giữa "had" và P.P.'
            },
            'q4': {
                answers: [
                    'She was hungry because she had not eaten anything all day.',
                    'She was hungry because she hadn\'t eaten anything all day.'
                ],
                prompt: 'she / be / hungry / because / she / not / eat / anything / all day',
                fullSentence: 'She was hungry because she had not eaten anything all day.',
                translation: 'Cô ấy đói vì cô ấy đã không ăn gì cả ngày.',
                explanation: 'Hành động "không ăn gì cả ngày" là nguyên nhân dẫn đến kết quả "cô ấy đói" ở quá khứ. Hành động không ăn xảy ra trước và kéo dài đến thời điểm cô ấy đói.',
                grammar_note: 'Sử dụng Quá khứ Hoàn thành (had + not + P.P.) để diễn tả nguyên nhân xảy ra trước một kết quả ở quá khứ. "Eat" là động từ bất quy tắc, P.P. là "eaten".'
            },
            'q5': {
                answers: [
                    'By the time I left school, I had decided to become a musician.',
                    'By the time I left school, I\'d decided to become a musician.'
                ],
                prompt: 'by the time / I leave / school / I / decide / to become / a musician',
                fullSentence: 'By the time I left school, I had decided to become a musician.',
                translation: 'Vào lúc tôi rời trường, tôi đã quyết định trở thành một nhạc sĩ.',
                explanation: 'Hành động "quyết định trở thành nhạc sĩ" xảy ra và hoàn thành trước thời điểm "tôi rời trường". "By the time" là dấu hiệu nhận biết.',
                grammar_note: 'Sử dụng Quá khứ Hoàn thành (had + P.P.) cho hành động xảy ra trước và Quá khứ Đơn (V2/ed) cho hành động xảy ra sau. "Decide" là động từ có quy tắc, P.P. là "decided".'
            }
        };

        /**
         * Normalizes a string by converting to lowercase, trimming whitespace,
         * and replacing multiple spaces with a single space.
         * @param {string} answer - The string to normalize.
         * @returns {string} The normalized string.
         */
        function normalizeAnswer(answer) {
            return answer.toLowerCase().replace(/\s+/g, ' ').trim();
        }

        /**
         * Submits the user's answers, calculates the score, provides feedback,
         * and displays detailed solutions.
         */
        function submitAnswers() {
            let score = 0;
            const totalQuestions = Object.keys(questionsData).length;

            const solutionListDiv = document.querySelector('#detailedSolution .solution-list');
            solutionListDiv.innerHTML = ''; // Clear previous solutions
            document.getElementById('detailedSolution').style.display = 'block'; // Show solution section

            // Iterate through each question ID in the questionsData
            Object.keys(questionsData).forEach(qId => {
                const inputElement = document.getElementById(qId);
                // If input element doesn't exist, skip (shouldn't happen with correct IDs)
                if (!inputElement) return;

                const userAnswer = normalizeAnswer(inputElement.value);
                const questionInfo = questionsData[qId];
                const feedbackIcon = document.getElementById(`icon${qId.substring(1)}`); // e.g., icon1 for q1

                // Reset feedback
                inputElement.classList.remove('is-valid', 'is-invalid');
                if (feedbackIcon) {
                    feedbackIcon.classList.remove('fa-check-circle', 'fa-times-circle', 'text-success', 'text-danger');
                    feedbackIcon.style.display = 'none';
                }

                let isCorrect = false;
                if (questionInfo.answers.some(ans => normalizeAnswer(ans) === userAnswer)) {
                    isCorrect = true;
                    score++;
                    inputElement.classList.add('is-valid');
                } else {
                    inputElement.classList.add('is-invalid');
                }

                // Show feedback icon
                if (feedbackIcon) {
                    if (isCorrect) {
                        feedbackIcon.classList.add('fa-check-circle', 'text-success');
                    } else {
                        feedbackIcon.classList.add('fa-times-circle', 'text-danger');
                    }
                    feedbackIcon.style.display = 'inline-block';
                }

                // Add detailed solution
                const solutionItem = document.createElement('div');
                solutionItem.classList.add('solution-item');

                const questionNumber = qId.substring(1);
                const questionTextSolutionDiv = document.createElement('div');
                questionTextSolutionDiv.classList.add('question-text-solution');
                questionTextSolutionDiv.innerHTML = `${questionNumber}. Gợi ý: <em>${questionInfo.prompt}</em><br>Đáp án: <span class="correct-answer-text">${questionInfo.fullSentence}</span>`;
                solutionItem.appendChild(questionTextSolutionDiv);

                const grammarExplanationDiv = document.createElement('div');
                grammarExplanationDiv.classList.add('grammar-explanation');
                grammarExplanationDiv.innerHTML = `<strong>Giải thích ngữ pháp & ngữ cảnh:</strong> ${questionInfo.explanation}<br>${questionInfo.grammar_note}`;
                solutionItem.appendChild(grammarExplanationDiv);

                const translationDiv = document.createElement('div');
                translationDiv.classList.add('translation');
                translationDiv.innerHTML = `<strong>Dịch:</strong> ${questionInfo.translation}`;
                solutionItem.appendChild(translationDiv);

                solutionListDiv.appendChild(solutionItem);
            });

            // Display score
            const scoreDisplay = document.getElementById('scoreDisplay');
            scoreDisplay.textContent = `Bạn đã đạt ${score} / ${totalQuestions} điểm.`;

            // Apply color coding to score display based on performance
            scoreDisplay.classList.remove('text-success', 'text-warning', 'text-danger');
            if (score === totalQuestions) {
                scoreDisplay.classList.add('text-success');
            } else if (score >= totalQuestions / 2) {
                scoreDisplay.classList.add('text-warning');
            } else {
                scoreDisplay.classList.add('text-danger');
            }
            scoreDisplay.style.display = 'block'; // Show the score display

            // Scroll to the score display
            scoreDisplay.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        /**
         * Resets the exercise by clearing inputs, hiding feedback, score, and solutions.
         */
        function resetExercise() {
            const inputElements = document.querySelectorAll('.answer-input');
            inputElements.forEach(input => {
                input.value = ''; // Clear input value
                input.classList.remove('is-valid', 'is-invalid'); // Remove feedback classes
            });

            const feedbackIcons = document.querySelectorAll('.feedback-icon');
            feedbackIcons.forEach(icon => {
                icon.classList.remove('fa-check-circle', 'fa-times-circle', 'text-success', 'text-danger');
                icon.style.display = 'none'; // Hide feedback icon
            });

            document.getElementById('scoreDisplay').textContent = ''; // Clear score text
            document.getElementById('scoreDisplay').style.display = 'none'; // Hide score display
            document.getElementById('detailedSolution').style.display = 'none'; // Hide solution section
            document.querySelector('#detailedSolution .solution-list').innerHTML = ''; // Clear solutions list
        }
    </script>
</body>
</html>
