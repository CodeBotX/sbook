<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài Tập Quá Khứ Hoàn Thành Tiếp diễn</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* General body styling */
        body {
            font-family: 'Open Sans', sans-serif;
            background-color: #f0f2f5;
            line-height: 1.6;
            color: #333;
            padding-top: 40px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        /* Main container for the exercise */
        .container-main {
            max-width: 900px;
            margin-top: 40px;
            margin-bottom: 40px;
            background-color: #ffffff;
            padding: 35px 45px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        /* Headings */
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
            font-weight: 700;
        }
        h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
            font-weight: 600;
        }

        /* Instruction section styling */
        .instruction {
            font-size: 1.1em;
            margin-bottom: 30px;
            color: #555;
            text-align: center;
            line-height: 1.5;
            background-color: #e8f5e9;
            border-left: 6px solid #4CAF50;
            padding: 20px 25px;
            border-radius: 10px;
            color: #388e3c;
        }

        /* Image container */
        .image-container {
            text-align: center;
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            background-color: #fdfdfd;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .image-container img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }

        /* Styling for each exercise item (question line) */
        .exercise-item {
            margin-bottom: 25px; /* Increased margin for better separation */
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            background-color: #fdfdfd;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        .exercise-item .question-number {
            font-weight: 600;
            color: #2c3e50;
            margin-right: 15px;
            margin-bottom: 10px; /* Space below number */
            display: block; /* Ensure number is on its own line */
        }
        .exercise-item .prompt-text {
            font-style: italic;
            color: #777;
            margin-bottom: 15px;
        }
        .exercise-item .answer-group {
            display: flex;
            align-items: baseline;
            flex-wrap: wrap;
            width: 100%;
        }
        .exercise-item .text-segment {
            margin-right: 5px;
            display: inline;
            white-space: pre-wrap;
        }
        .exercise-item .answer-input {
            flex-grow: 1; /* Allow input to grow and fill space */
            min-width: 250px; /* Minimum width for input */
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ced4da;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            font-size: 1em; /* Ensure font size is readable */
        }
        .exercise-item .answer-input:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        /* Feedback borders for inputs */
        .exercise-item .answer-input.is-valid {
            border-color: #198754 !important;
            box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25) !important;
            background-color: #d1e7dd;
            color: #0f5132;
        }
        .exercise-item .answer-input.is-invalid {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25) !important;
            background-color: #f8d7da;
            color: #842029;
        }

        /* Feedback icons (check/cross) */
        .feedback-icon {
            margin-left: 10px;
            font-size: 1.2em;
            display: none; /* Hidden by default, shown by JS */
            flex-shrink: 0;
        }
        .feedback-icon.text-success { color: #198754; }
        .feedback-icon.text-danger { color: #dc3545; }

        /* Buttons styling */
        .buttons .btn {
            padding: 12px 30px;
            font-size: 1.1em;
            margin: 0 15px;
            border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .buttons .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        /* Score display styling */
        .score-display {
            font-size: 1.3em;
            font-weight: 700;
            color: #007bff;
            margin-top: 30px;
            margin-bottom: 25px;
            text-align: center;
            padding: 10px 20px;
            border-radius: 8px;
            background-color: #e6f7ff;
            border: 1px solid #b3e0ff;
            display: none;
        }
        .score-display.text-success { background-color: #d1e7dd; border-color: #a3cfb4; color: #198754; }
        .score-display.text-warning { background-color: #fff3cd; border-color: #ffeeba; color: #ffc107; }
        .score-display.text-danger { background-color: #f8d7da; border-color: #f5c2c7; color: #dc3545; }

        /* Detailed solution section styling */
        .solution-section {
            margin-top: 40px;
            padding-top: 25px;
            border-top: 1px dashed #ced4da;
            display: none;
        }
        .solution-section h2 {
            color: #007bff;
            font-weight: 700;
            margin-bottom: 25px;
            text-align: center;
        }
        .solution-list .solution-item {
            margin-bottom: 20px;
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-left: 5px solid #007bff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .solution-list .solution-item .question-text-solution {
            font-weight: 600;
            color: #34495e;
            margin-bottom: 8px;
        }
        .solution-list .solution-item .correct-answer-text {
            font-weight: 700;
            color: #198754;
            text-decoration: underline;
            margin-right: 5px;
        }
        .solution-list .solution-item .grammar-explanation {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
            background-color: #e9ecef;
            padding: 8px 12px;
            border-radius: 5px;
            border-left: 3px solid #6c757d;
        }
        .solution-list .solution-item .translation {
            font-style: italic;
            color: #6c757d;
            font-size: 0.95em;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #e0e0e0;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container-main {
                padding: 25px;
                margin: 20px auto;
            }
            h1 {
                font-size: 1.8em;
            }
            h2 {
                font-size: 1.5em;
            }
            .instruction {
                font-size: 0.95em;
                padding: 15px;
            }
            .exercise-item {
                padding: 15px;
                margin-bottom: 20px;
            }
            .exercise-item .answer-input {
                width: 100%;
                max-width: 100%;
                margin-bottom: 10px;
            }
            .buttons .btn {
                font-size: 1.1em;
                padding: 10px 25px;
                margin: 0 8px;
            }
            .score-display {
                font-size: 1.3em;
                padding: 12px;
            }
            .solution-list .solution-item {
                padding: 10px 15px;
            }
            .solution-list .solution-item .grammar-explanation,
            .solution-list .solution-item .translation {
                font-size: 0.85em;
            }
        }
    </style>
</head>
<body>
    <div class="container container-main">
        <div class="d-flex align-items-center justify-content-center mb-4">
            <h1>Bài Tập Ngữ Pháp</h1>
        </div>
        <h2>Hoàn thành câu sử dụng thì Quá khứ Hoàn thành Tiếp diễn</h2>
        <p class="instruction">
            <strong>Instructions:</strong> Look at the pictures and complete the sentences. Use the correct form of the past perfect continuous.
            <br>
            <strong>Hướng dẫn:</strong> Nhìn vào các bức tranh và hoàn thành các câu. Sử dụng dạng Quá khứ Hoàn thành Tiếp diễn đúng.
            <br>
            <span class="text-muted">(Lưu ý: Đáp án và lời giải chi tiết sẽ hiển thị sau khi bạn nhấn "Kiểm tra".)</span>
        </p>

        <div class="image-container">
            <img src="5-d.png" alt="Various scenes: tired girl, dancing people, flooded garden, crashed car, people waiting at cafe">
            <p class="text-muted mt-2">[Hình ảnh: Các cảnh khác nhau: cô gái mệt mỏi, người đang nhảy múa, vườn bị ngập lụt, xe bị tai nạn, người đang đợi ở quán cà phê]</p>
        </div>

        <form id="grammarForm">
            <div class="exercise-item">
                <span class="question-number">1.</span>
                <span class="text-segment">She was tired because</span>
                <input type="text" class="form-control answer-input" id="q1" name="q1" placeholder="Your answer">
                <span class="text-segment">.</span>
                <span class="hint-word">(run)</span>
                <i class="feedback-icon fa-solid" id="icon1"></i>
            </div>

            <div class="exercise-item">
                <span class="question-number">2.</span>
                <span class="text-segment">They were hot because</span>
                <input type="text" class="form-control answer-input" id="q2" name="q2" placeholder="Your answer">
                <span class="text-segment">.</span>
                <span class="hint-word">(dance)</span>
                <i class="feedback-icon fa-solid" id="icon2"></i>
            </div>

            <div class="exercise-item">
                <span class="question-number">3.</span>
                <span class="text-segment">The garden was flooded because</span>
                <input type="text" class="form-control answer-input" id="q3" name="q3" placeholder="Your answer">
                <span class="text-segment">.</span>
                <span class="hint-word">(it/rain/all night)</span>
                <i class="feedback-icon fa-solid" id="icon3"></i>
            </div>

            <div class="exercise-item">
                <span class="question-number">4.</span>
                <span class="text-segment">Did they crash because</span>
                <input type="text" class="form-control answer-input" id="q4" name="q4" placeholder="Your answer">
                <span class="text-segment">?</span>
                <span class="hint-word">(drive / too fast)</span>
                <i class="feedback-icon fa-solid" id="icon4"></i>
            </div>

            <div class="exercise-item">
                <span class="question-number">5.</span>
                <span class="text-segment">When I arrived,</span>
                <input type="text" class="form-control answer-input" id="q5" name="q5" placeholder="Your answer">
                <span class="text-segment">.</span>
                <span class="hint-word">(they / wait for over half an hour)</span>
                <i class="feedback-icon fa-solid" id="icon5"></i>
            </div>

            <div class="exercise-item">
                <span class="question-number">6.</span>
                <span class="text-segment">When I got there,</span>
                <input type="text" class="form-control answer-input" id="q6" name="q6" placeholder="Your answer">
                <span class="text-segment">.</span>
                <span class="hint-word">(they/not/wait / long)</span>
                <i class="feedback-icon fa-solid" id="icon6"></i>
            </div>

            <div class="buttons text-center mt-5">
                <button type="button" class="btn btn-primary me-3" onclick="submitAnswers()">Kiểm tra</button>
                <button type="button" class="btn btn-secondary" onclick="resetExercise()">Làm lại</button>
            </div>
        </form>

        <div id="scoreDisplay" class="score-display mt-4"></div>

        <div class="solution-section" id="detailedSolution">
            <h2>Lời giải chi tiết và Giải thích</h2>
            <div class="solution-list">
                </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // Define correct answers, original text templates, translations, and explanations for each question
        const questionsData = {
            'q1': {
                answers: ['she had been running'],
                originalText: 'She was tired because {answer}.',
                translation: 'Cô ấy mệt vì cô ấy đã chạy bộ.',
                explanation: 'Sử dụng thì Quá khứ Hoàn thành Tiếp diễn để diễn tả một hành động (chạy bộ) đã diễn ra liên tục trong một khoảng thời gian và là nguyên nhân trực tiếp dẫn đến một trạng thái ở quá khứ (mệt mỏi).',
                grammar_note: 'Cấu trúc: S + had + been + V-ing. Nhấn mạnh quá trình của hành động gây ra kết quả ở quá khứ.'
            },
            'q2': {
                answers: ['they had been dancing'],
                originalText: 'They were hot because {answer}.',
                translation: 'Họ nóng vì họ đã nhảy múa.',
                explanation: 'Tương tự, hành động "nhảy múa" đã diễn ra liên tục và là nguyên nhân khiến họ cảm thấy nóng ở quá khứ.',
                grammar_note: 'Cấu trúc: S + had + been + V-ing.'
            },
            'q3': {
                answers: ['it had been raining all night'],
                originalText: 'The garden was flooded because {answer}.',
                translation: 'Khu vườn bị ngập vì trời đã mưa suốt đêm.',
                explanation: 'Hành động "mưa" đã diễn ra liên tục trong suốt đêm ("all night") và là nguyên nhân dẫn đến việc khu vườn bị ngập ở quá khứ.',
                grammar_note: 'Cấu trúc: S + had + been + V-ing. "All night" nhấn mạnh khoảng thời gian liên tục của hành động.'
            },
            'q4': {
                answers: ['they had been driving too fast'],
                originalText: 'Did they crash because {answer}?',
                translation: 'Họ có bị tai nạn vì họ đã lái xe quá nhanh không?',
                explanation: 'Hành động "lái xe quá nhanh" đã diễn ra liên tục và là nguyên nhân dẫn đến vụ tai nạn ở quá khứ. Đây là câu hỏi về nguyên nhân của một sự việc đã xảy ra.',
                grammar_note: 'Cấu trúc câu hỏi: Had + S + been + V-ing? Nhấn mạnh quá trình gây ra sự việc.'
            },
            'q5': {
                answers: ['they had been waiting for over half an hour'],
                originalText: 'When I arrived, {answer}.',
                translation: 'Khi tôi đến, họ đã đợi hơn nửa tiếng rồi.',
                explanation: 'Hành động "đợi" đã diễn ra liên tục trong hơn nửa tiếng ("for over half an hour") trước khi hành động "tôi đến" xảy ra trong quá khứ. Hành động đợi vẫn đang tiếp diễn hoặc vừa mới kết thúc khi tôi đến.',
                grammar_note: 'Sử dụng Quá khứ Hoàn thành Tiếp diễn cho hành động kéo dài đến một thời điểm trong quá khứ. "For + khoảng thời gian" là dấu hiệu nhận biết.'
            },
            'q6': {
                answers: ['they had not been waiting long', 'they hadn\'t been waiting long'],
                originalText: 'When I got there, {answer}.',
                translation: 'Khi tôi đến đó, họ đã không đợi lâu.',
                explanation: 'Hành động "đợi" không diễn ra liên tục trong một khoảng thời gian dài trước khi hành động "tôi đến" xảy ra trong quá khứ. Dạng phủ định của thì Quá khứ Hoàn thành Tiếp diễn.',
                grammar_note: 'Cấu trúc phủ định: S + had + not + been + V-ing.'
            }
        };

        /**
         * Normalizes a string by converting to lowercase, trimming whitespace,
         * and replacing multiple spaces with a single space.
         * @param {string} answer - The string to normalize.
         * @returns {string} The normalized string.
         */
        function normalizeAnswer(answer) {
            return answer.toLowerCase().replace(/\s+/g, ' ').trim();
        }

        /**
         * Submits the user's answers, calculates the score, provides feedback,
         * and displays detailed solutions.
         */
        function submitAnswers() {
            let score = 0;
            const totalQuestions = Object.keys(questionsData).length;

            const solutionListDiv = document.querySelector('#detailedSolution .solution-list');
            solutionListDiv.innerHTML = ''; // Clear previous solutions
            document.getElementById('detailedSolution').style.display = 'block'; // Show solution section

            // Iterate through each question ID in the questionsData
            Object.keys(questionsData).forEach(qId => {
                const inputElement = document.getElementById(qId);
                // If input element doesn't exist, skip (shouldn't happen with correct IDs)
                if (!inputElement) return;

                const userAnswer = normalizeAnswer(inputElement.value);
                const questionInfo = questionsData[qId];
                const feedbackIcon = document.getElementById(`icon${qId.substring(1)}`); // e.g., icon1 for q1

                // Reset feedback
                inputElement.classList.remove('is-valid', 'is-invalid');
                if (feedbackIcon) {
                    feedbackIcon.classList.remove('fa-check-circle', 'fa-times-circle', 'text-success', 'text-danger');
                    feedbackIcon.style.display = 'none';
                }

                let isCorrect = false;
                if (questionInfo.answers.some(ans => normalizeAnswer(ans) === userAnswer)) {
                    isCorrect = true;
                    score++;
                    inputElement.classList.add('is-valid');
                } else {
                    inputElement.classList.add('is-invalid');
                }

                // Show feedback icon
                if (feedbackIcon) {
                    if (isCorrect) {
                        feedbackIcon.classList.add('fa-check-circle', 'text-success');
                    } else {
                        feedbackIcon.classList.add('fa-times-circle', 'text-danger');
                    }
                    feedbackIcon.style.display = 'inline-block';
                }

                // Add detailed solution
                const solutionItem = document.createElement('div');
                solutionItem.classList.add('solution-item');

                const questionNumber = qId.substring(1);
                const questionTextSolutionDiv = document.createElement('div');
                questionTextSolutionDiv.classList.add('question-text-solution');
                questionTextSolutionDiv.innerHTML = `${questionNumber}. Gợi ý: <em>${questionInfo.originalText.replace('{answer}', '')}</em><br>Đáp án: <span class="correct-answer-text">${questionInfo.fullSentence || questionInfo.originalText.replace('{answer}', questionInfo.answers[0])}</span>`;
                solutionItem.appendChild(questionTextSolutionDiv);

                const grammarExplanationDiv = document.createElement('div');
                grammarExplanationDiv.classList.add('grammar-explanation');
                grammarExplanationDiv.innerHTML = `<strong>Giải thích ngữ pháp & ngữ cảnh:</strong> ${questionInfo.explanation}<br>${questionInfo.grammar_note}`;
                solutionItem.appendChild(grammarExplanationDiv);

                const translationDiv = document.createElement('div');
                translationDiv.classList.add('translation');
                translationDiv.innerHTML = `<strong>Dịch:</strong> ${questionInfo.translation}`;
                solutionItem.appendChild(translationDiv);

                solutionListDiv.appendChild(solutionItem);
            });

            // Display score
            const scoreDisplay = document.getElementById('scoreDisplay');
            scoreDisplay.textContent = `Bạn đã đạt ${score} / ${totalQuestions} điểm.`;

            // Apply color coding to score display based on performance
            scoreDisplay.classList.remove('text-success', 'text-warning', 'text-danger');
            if (score === totalQuestions) {
                scoreDisplay.classList.add('text-success');
            } else if (score >= totalQuestions / 2) {
                scoreDisplay.classList.add('text-warning');
            } else {
                scoreDisplay.classList.add('text-danger');
            }
            scoreDisplay.style.display = 'block'; // Show the score display

            // Scroll to the score display
            scoreDisplay.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        /**
         * Resets the exercise by clearing inputs, hiding feedback, score, and solutions.
         */
        function resetExercise() {
            const inputElements = document.querySelectorAll('.answer-input');
            inputElements.forEach(input => {
                input.value = ''; // Clear input value
                input.classList.remove('is-valid', 'is-invalid'); // Remove feedback classes
            });

            const feedbackIcons = document.querySelectorAll('.feedback-icon');
            feedbackIcons.forEach(icon => {
                icon.classList.remove('fa-check-circle', 'fa-times-circle', 'text-success', 'text-danger');
                icon.style.display = 'none'; // Hide feedback icon
            });

            document.getElementById('scoreDisplay').textContent = ''; // Clear score text
            document.getElementById('scoreDisplay').style.display = 'none'; // Hide score display
            document.getElementById('detailedSolution').style.display = 'none'; // Hide solution section
            document.querySelector('#detailedSolution .solution-list').innerHTML = ''; // Clear solutions list
        }
    </script>
</body>
</html>
